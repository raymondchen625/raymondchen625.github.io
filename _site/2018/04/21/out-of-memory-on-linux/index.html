<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Out of Memory on Linux | Raymond’s Blog</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Out of Memory on Linux" />
<meta name="author" content="raymondchen625" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve been working on optimizing parameters for Kubernetes pods for testing environment VMs lately." />
<meta property="og:description" content="I’ve been working on optimizing parameters for Kubernetes pods for testing environment VMs lately." />
<link rel="canonical" href="http://localhost:4000/2018/04/21/out-of-memory-on-linux/" />
<meta property="og:url" content="http://localhost:4000/2018/04/21/out-of-memory-on-linux/" />
<meta property="og:site_name" content="Raymond’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-21T18:11:23-04:00" />
<script type="application/ld+json">
{"description":"I’ve been working on optimizing parameters for Kubernetes pods for testing environment VMs lately.","author":{"@type":"Person","name":"raymondchen625"},"@type":"BlogPosting","url":"http://localhost:4000/2018/04/21/out-of-memory-on-linux/","headline":"Out of Memory on Linux","dateModified":"2018-04-21T18:11:23-04:00","datePublished":"2018-04-21T18:11:23-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/04/21/out-of-memory-on-linux/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Raymond's Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Raymond&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Out of Memory on Linux</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-04-21T18:11:23-04:00" itemprop="datePublished">Apr 21, 2018
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">raymondchen625</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I’ve been working on optimizing parameters for Kubernetes pods for testing environment VMs lately.</p>

<p>When I deploy a certain number of pods, the system hangs. The root cause is out of memory, or more directly many pods have their JVM heap size set to big or unset.</p>

<p>JVM has strange behaviours on Docker Container: (<a href="https://blogs.oracle.com/java-platform-group/java-se-support-for-docker-cpu-and-memory-limits">Source</a>) Simply put, if we let it unset, it only sees the RAM amount of the host and tries to initialize with a heap 1/4 of it. Once I turn down the max heap size of each pod explicitly, the VM can run a lot more pods at the same time.</p>

<p>I also found interesting things along the investigation. My test environment has swap turned on, which is not recommended in production. I can observe when I overdeploy the pods, there are a lot of swapping activity. The kswapd0 process takes a large trunk of CPU and the system becomes sluggish.</p>

<p>I tried to turn off the swap and redeployed, which is not a solution by the way, just for experiment. The system hung, not even sluggish this time.</p>

<p>Wondering what had happened, I did it again with swap on first, turn it off with all pods running. The swapoff command got killed. I could see a lot of state=D process showing up in a monitoring window checking the process like image below:</p>

<p><img class="alignnone size-full wp-image-1528" src="http://localhost/wp-content/uploads/2018/04/swapoff.png" alt="SwapOff" width="1847" height="860" srcset="http://localhost/wp-content/uploads/2018/04/swapoff.png 1847w, http://localhost/wp-content/uploads/2018/04/swapoff-300x140.png 300w, http://localhost/wp-content/uploads/2018/04/swapoff-768x358.png 768w, http://localhost/wp-content/uploads/2018/04/swapoff-1024x477.png 1024w, http://localhost/wp-content/uploads/2018/04/swapoff-1568x730.png 1568w" sizes="(max-width: 1847px) 100vw, 1847px" /></p>

<p>So my conclusion is: when swap is off, if the pod can not get the RAM it is allocated when it started up, it enters the D (uninterruptible sleep) state and takes a lot of CPU. Nothing the system can do since there is no swap to turn to. So the system hangs. If we try to turn off swap when the system is already using a lot of swap to handle those pods, it will get a lot of processes to D state like shown in the screen capture. Once the swapoff command is killed due to failure, the system can use swap again, the ‘D’-state process will eventually disappear(get into other states).</p>

<p>A nice post on D state is <a href="https://stackoverflow.com/questions/223644/what-is-an-uninterruptable-process">here</a>.</p>

  </div><a class="u-url" href="/2018/04/21/out-of-memory-on-linux/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Raymond&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Raymond&#39;s Blog</li><li><a class="u-email" href="mailto:raymond@raymondchen.com">raymond@raymondchen.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/raymondchen625"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">raymondchen625</span></a></li><li><a href="https://www.twitter.com/raymondchen625"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">raymondchen625</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
